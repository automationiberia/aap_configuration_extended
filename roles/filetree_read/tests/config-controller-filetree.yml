---
- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    controller_configuration_projects_async_retries: 60
    controller_configuration_projects_async_delay: 2
  pre_tasks:
    - block:
        - name: "Check if the collection ansible.controller is installed"
          set_fact:
            ansible_controller_collection_installed: "{{ lookup('pipe', 'ansible-galaxy collection list | grep -i ansible.controllersss') }}"
      rescue:
        - name: "Check if the collection awx.awx is installed"
          set_fact:
            awx_awx_collection_installed: "{{ lookup('pipe', 'ansible-galaxy collection list | grep -i awx.awx') }}"
      always:
        - name: "Set the collection providing the controller_api lookup plugin"
          set_fact:
            controller_api_plugin: "{{ ('ansible.controller.controller_api' if ansible_controller_collection_installed is defined) | default('awx.awx.controller_api' if awx_awx_collection_installed is defined) | default('NONE') }}"
        - name: "Fail if no collection is detected"
          fail:
            msg: "One of the following collections is required to be installed: 'ansible.controller' or 'awx.awx'."
          when: controller_api_plugin is match('NONE')
        - name: "Show the plugin we are using"
          debug:
            msg: "Using the 'controller_api' plugin from: {{ controller_api_plugin }}"

    - block:
        - name: Include Tasks to load Galaxy credentials to be added to Organizations
          ansible.builtin.include_role:
            name: redhat_cop.controller_configuration.filetree_read
            tasks_from: "{{ create_orgs_credentials }}"
          loop:
            - organizations.yml
            - credentials.yml
          loop_control:
            loop_var: create_orgs_credentials

        - name: Include Tasks to add Galaxy credentials to Organizations
          ansible.builtin.include_role:
            name: redhat_cop.controller_configuration.dispatch
            apply:
              tags:
                - organizations
                - credentials
          vars:
            assign_galaxy_credentials_to_org: false
            controller_configuration_dispatcher_roles:
              - {role: organizations, var: controller_organizations, tags: organizations}
              - {role: credentials, var: controller_credentials, tags: credentials}

  roles:
    - {role: redhat_cop.controller_configuration.filetree_read}
    - {role: redhat_cop.controller_configuration.dispatch}
...
