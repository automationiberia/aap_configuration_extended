---
- name: Get the organization ID
  set_fact:
    controller_organization_id: "{{ lookup('ansible.controller.controller_api', 'organizations', query_params={ 'name': orgs },
      host=controller_hostname, oauth_token=oauthtoken, verify_ssl=false) }}"

- name: "OBJECT DIFF: Get the API list of all inventories"
  set_fact:
    __controller_api_inventories: "{{ query('ansible.controller.controller_api', 'inventories',
      query_params={
        'organization': controller_organization_id.id,
        'has_inventory_sources': 'false',
        'not__total_groups': '0',
        'not__kind': 'smart'
      },
      host=controller_hostname, username=controller_username,
      password=controller_password, verify_ssl=false) }}"

- name: "OBJECT DIFF: Get the API list of all groups in the inventories at organization {{ orgs }}"
  set_fact:
    __controller_api_groups: "{{ (__controller_api_groups | default([])) + query('ansible.controller.controller_api', 'groups',
      query_params={ 'inventory': current_inventory.id },
      host=controller_hostname, username=controller_username,
      password=controller_password, verify_ssl=false) }}"
  loop: "{{ __controller_api_inventories }}"
  loop_control:
    loop_var: current_inventory

- block:
    - name: "OBJECT DIFF: Find the difference of Project between what is on the Controller versus CasC on SCM"
      set_fact:
        __groups_difference: "{{ lookup('redhat_cop.controller_configuration.controller_object_diff',
          query_params={ 'summary_fields.inventory.organization_id': controller_organization_id.id },
          api_list=__controller_api_groups, compare_list=controller_groups,
          with_present=false, set_absent=true ) }}"

    - name: "OBJECT DIFF: Set the inventory key at the correct place"
      set_fact:
        controller_groups: "{{ __groups_difference }}"

  when: __controller_api_groups is defined
...
